<upgrade xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <target>0.3.*.*</target>
  <target-stack>HDF-0.3</target-stack>
  <type>NON_ROLLING</type>
  <downgrade-allowed>false</downgrade-allowed>
  <prerequisite-checks>
    
    <check>org.apache.ambari.server.checks.StormRestAPIDeletedCheck</check>

    <configuration>
      
      <check-properties name="org.apache.ambari.server.checks.HiveDynamicServiceDiscoveryCheck">
        <property name="min-failure-stack-version">HDF-0.3.0.0</property>
      </check-properties>
    </configuration>
  </prerequisite-checks>

  
  <upgrade-path>
    <intermediate-stack version="2.2" />
    <intermediate-stack version="2.3" />
  </upgrade-path>

  <order>
    <group name="PRE_CLUSTER" title="Prepare Upgrade" xsi:type="cluster">
      <direction>UPGRADE</direction>

      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>

      <execute-stage component="RESOURCEMANAGER" service="YARN" title="Stop YARN Queues">
        <task xsi:type="manual">
          <message>Before continuing, please stop all YARN queues. If yarn-site's yarn.resourcemanager.work-preserving-recovery.enabled is set to true, then you can skip this step since the clients will retry on their own.</message>
        </task>
      </execute-stage>

      <execute-stage component="NIMBUS" service="STORM" title="Stop Storm Topologies">
        <task xsi:type="manual">
          <message>Before continuing, please deactivate and kill any currently running topologies.</message>
        </task>
      </execute-stage>

      <execute-stage component="TEZ_CLIENT" service="TEZ" title="Check Tez Tarball">
        <task hosts="any" xsi:type="execute">
          <script>scripts/pre_upgrade.py</script>
          <function>prepare</function>
        </task>
      </execute-stage>
    </group>

    <group name="STOP_HIGH_LEVEL_SERVICE_COMPONENTS" title="Stop Components for High-Level Services" xsi:type="stop">
      <direction>UPGRADE</direction>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <service-check>false</service-check>
      <parallel-scheduler />

      <service name="FLUME">
        <component>FLUME_HANDLER</component>
      </service>

      <service name="STORM">
        <component>DRPC_SERVER</component>
        <component>STORM_UI_SERVER</component>
        <component>SUPERVISOR</component>
        <component>STORM_REST_API</component>
        <component>NIMBUS</component>
      </service>

      <service name="FALCON">
        <component>FALCON_SERVER</component>
      </service>

      <service name="OOZIE">
        <component>OOZIE_SERVER</component>
      </service>

      <service name="HIVE">
        <component>WEBHCAT_SERVER</component>
        <component>HIVE_SERVER</component>
        <component>HIVE_METASTORE</component>
      </service>

      <service name="YARN">
        <component>NODEMANAGER</component>
        <component>RESOURCEMANAGER</component>
        <component>APP_TIMELINE_SERVER</component>
      </service>

      <service name="MAPREDUCE2">
        <component>HISTORYSERVER</component>
      </service>
    </group>

    <group name="Backups" title="Perform Backups" xsi:type="cluster">
      <direction>UPGRADE</direction>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>

      <execute-stage component="OOZIE_SERVER" service="OOZIE" title="Backup Oozie Database">
        <task xsi:type="manual">
          <message>Before continuing, please backup the Oozie Server database referenced by the Oozie server located on {{hosts.all}}.</message>
        </task>
      </execute-stage>

      <execute-stage component="HIVE_METASTORE" service="HIVE" title="Backup Hive Metastore">
        <task xsi:type="manual">
          <message>Before continuing, please backup the Hive Metastore database referenced by the Hive Metastore service(s) located on the following host(s): {{hosts.all}}.</message>
        </task>
      </execute-stage>

      <execute-stage component="HBASE_MASTER" service="HBASE" title="Snapshot HBASE">
        <task hosts="master" xsi:type="execute">
          <script>scripts/hbase_upgrade.py</script>
          <function>take_snapshot</function>
        </task>
      </execute-stage>

      <execute-stage component="NAMENODE" service="HDFS" title="Prepare HDFS">
        <task hosts="master" xsi:type="execute">
          <script>scripts/namenode.py</script>
          <function>prepare_express_upgrade</function>
        </task>
      </execute-stage>
    </group>

    <group name="STOP_LOW_LEVEL_SERVICE_COMPONENTS" title="Stop Components for Core Services" xsi:type="stop">
      <direction>UPGRADE</direction>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <service-check>false</service-check>
      <parallel-scheduler />

      <service name="HBASE">
        <component>HBASE_REGIONSERVER</component>
        <component>HBASE_MASTER</component>
      </service>

      <service name="HDFS">
        <component>DATANODE</component>
        <component>NAMENODE</component>
        <component>SECONDARY_NAMENODE</component>
        <component>ZKFC</component>
        <component>JOURNALNODE</component>
      </service>

      <service name="ZOOKEEPER">
        <component>ZOOKEEPER_SERVER</component>
      </service>
    </group>

    <group name="Restore Backups" title="Restore Backups" xsi:type="cluster">
      <direction>DOWNGRADE</direction>
      <skippable>true</skippable>

      

      <execute-stage component="OOZIE_SERVER" service="OOZIE" title="Restore Oozie Database">
        <task xsi:type="manual">
          <message>Before continuing, please restore the Oozie Server database referenced by the Oozie server located on {{hosts.all}}.</message>
        </task>
      </execute-stage>

      <execute-stage component="HIVE_METASTORE" service="HIVE" title="Restore Hive Metastore">
        <task xsi:type="manual">
          <message>Before continuing, please restore the Hive Metastore database referenced by the Hive Metastore service(s) located on the following host(s): {{hosts.all}}.</message>
        </task>
      </execute-stage>
    </group>

    
    <group name="REMOVE_HDF_21" title="Remove HDF 0.1" xsi:type="cluster">
      <direction>UPGRADE</direction>

      <execute-stage title="Confirm removing HDF 0.1">
        <task xsi:type="manual">
          <message>Please confirm you want to proceed, which will delete HDF 0.1. This is because HDF 0.1 did not use versioned packages and cannot coexist with HDF 0.3</message>
        </task>
      </execute-stage>

      <execute-stage title="Remove HDF 0.1">
        <task xsi:type="execute">
          <script>scripts/remove_bits.py</script>
          <function>remove_hdf_21</function>
        </task>
      </execute-stage>
    </group>

    
    <group name="UPDATE_DESIRED_STACK_ID" title="Update Target Stack" xsi:type="update-stack">
      <execute-stage component="" service="" title="Update Target Stack">
        <task class="org.apache.ambari.server.serveraction.upgrades.UpdateDesiredStackAction" xsi:type="server_action">
        </task>
      </execute-stage>
    </group>

    <group name="Upgrade service configs" title="Upgrade service configs" xsi:type="cluster">
      <direction>UPGRADE</direction>   
      <skippable>true</skippable>  
      <supports-auto-skip-failure>false</supports-auto-skip-failure>

      
      
      <execute-stage component="NAMENODE" service="HDFS" title="Apply config changes for NameNode without Ranger">
        <task id="hdf_2_2_0_0_namenode_no_ranger" xsi:type="configure" />
      </execute-stage>

      
      <execute-stage component="HISTORYSERVER" service="MAPREDUCE2" title="Apply config changes for HistoryServer">
        <task id="hdf_2_2_0_0_historyserver_classpath" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="HISTORYSERVER" service="MAPREDUCE2" title="Apply config changes for YARN without Ranger">
        <task id="hdf_2_2_0_0_historyserver_no_ranger" xsi:type="configure" />
      </execute-stage>

      
      <execute-stage component="NIMBUS" service="STORM" title="Apply config changes for Nimbus without Ranger">
        <task id="hdf_2_2_0_0_nimbus_no_ranger" xsi:type="configure" />
      </execute-stage>

      
      
      <execute-stage component="NAMENODE" service="HDFS" title="Apply config changes for NameNode">
        <task id="hdf_2_3_0_0_modify_hadoop_env" xsi:type="configure" />
      </execute-stage>

      
      <execute-stage component="HISTORYSERVER" service="MAPREDUCE2" title="Apply config changes for HistoryServer">
        <task id="hdf_2_3_0_0_mapreduce2_adjust_history_server" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="MAPREDUCE2_CLIENT" service="MAPREDUCE2" title="Apply config changes for Mapreduce2 client">
        <task class="org.apache.ambari.server.serveraction.upgrades.FixLzoCodecPath" summary="Verifying LZO codec path for mapreduce" xsi:type="server_action" />
      </execute-stage>

      <execute-stage component="APP_TIMELINE_SERVER" service="YARN" title="Apply config changes for AppTimelineServer">
        <task id="hdf_2_3_0_0_yarn_ats_enable_recovery" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="APP_TIMELINE_SERVER" service="YARN" title="Apply config changes for AppTimelineServer">
        <task id="hdf_2_3_0_0_yarn_keep_ats_v1" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="RESOURCEMANAGER" service="YARN" title="Apply config changes for ResourceManager">
        <task id="hdf_2_3_0_0_yarn_rm_disable_node_labels" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="RESOURCEMANAGER" service="YARN" title="Apply config changes for ResourceManager">
        <task id="hdf_2_3_0_0_yarn_rm_clear_default_node_label_expression" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="RESOURCEMANAGER" service="YARN" title="Apply config changes for ResourceManager">
        <task id="hdf_2_3_0_0_yarn_rm_check_cs_root_def_capacity" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="RESOURCEMANAGER" service="YARN" title="Apply config changes for ResourceManager">
        <task id="hdf_2_3_0_0_yarn_rm_check_cs_root_max_capacity" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="RESOURCEMANAGER" service="YARN" title="Calculating Yarn Properties">
        <task class="org.apache.ambari.server.serveraction.upgrades.YarnConfigCalculation" summary="Calculating Yarn Properties" xsi:type="server_action" />
      </execute-stage>

      
      <execute-stage component="HBASE_MASTER" service="HBASE" title="Apply config changes for HBase Master">
        <task id="hdf_2_3_0_0_hbase_master_set_global_memstore_size" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="HBASE_MASTER" service="HBASE" title="Calculating HBase Properties">
        <task class="org.apache.ambari.server.serveraction.upgrades.HBaseConfigCalculation" summary="Calculating HBase Properties" xsi:type="server_action" />
      </execute-stage>

      <execute-stage component="HBASE_MASTER" service="HBASE" title="Apply config changes for HBase Master">
        <task id="hdf_2_3_0_0_hbase_master_adjust_authorization_coprocessors" xsi:type="configure" />
      </execute-stage>

      
      <execute-stage component="TEZ_CLIENT" service="TEZ" title="Apply config changes for Tez">
        <task id="hdf_2_3_0_0_tez_client_adjust_properties" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="TEZ_CLIENT" service="TEZ" title="Apply config changes for Tez">
        <task id="hdf_2_3_0_0_tez_client_adjust_tez_lib_uris_property" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="TEZ_CLIENT" service="TEZ" title="Apply config changes for Tez">
        <task id="hdf_2_3_0_0_tez_keep_ats_v1" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="TEZ_CLIENT" service="TEZ" title="Verify LZO codec path for Tez">
        <task class="org.apache.ambari.server.serveraction.upgrades.FixLzoCodecPath" summary="Verifying LZO codec path for Tez" xsi:type="server_action" />
      </execute-stage>

      
      <execute-stage component="HIVE_SERVER" service="HIVE" title="Apply config changes for Hive Server">
        <task class="org.apache.ambari.server.serveraction.upgrades.HiveZKQuorumConfigAction" summary="Calculating ZooKeeper Quorum Properties for Hive" xsi:type="server_action" />
      </execute-stage>

      <execute-stage component="HIVE_SERVER" service="HIVE" title="Apply config changes for Hive Server">
        <task id="hdf_2_2_0_0_hive_server_delegation_token_store_class" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="HIVE_SERVER" service="HIVE" title="Apply config changes for Hive Server">
        <task id="hdf_2_3_0_0_hive_server_remove_datastore_classname" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="HIVE_SERVER" service="HIVE" title="Apply config changes for Hive Server">
        <task id="hdf_2_3_0_0_hive_server_replace_auth_manager" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="HIVE_SERVER" service="HIVE" title="Apply config changes for Hive Server">
        <task id="hdf_2_3_0_0_hive_server_configure_authentication" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="WEBHCAT_SERVER" service="HIVE" title="Apply config changes for WebHCat Server">
        <task id="hdf_2_3_0_0_webhcat_server_update_env" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="WEBHCAT_SERVER" service="HIVE">
        <task id="hdf_2_3_0_0_webhcat_server_update_configuration_paths" xsi:type="configure" />
      </execute-stage>

      
      <execute-stage component="OOZIE_SERVER" service="OOZIE" title="Apply config changes for Oozie Server">
        <task id="hdf_2_3_0_0_oozie_remove_redundant_configurations" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="OOZIE_SERVER" service="OOZIE" title="Apply config changes for Oozie Server">
        <task class="org.apache.ambari.server.serveraction.upgrades.OozieConfigCalculation" summary="Adjusting Oozie properties" xsi:type="server_action" />
      </execute-stage>

      
      <execute-stage component="FALCON_SERVER" service="FALCON" title="Apply config changes for Falcon Server">
        <task id="hdf_2_2_0_0_falcon_application_services" xsi:type="configure" />
      </execute-stage>

      
      <execute-stage component="NIMBUS" service="STORM" title="Apply config changes for Nimbus">
        <task id="hdf_2_3_0_0_nimbus_convert_nimbus_host_to_seeds" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="NIMBUS" service="STORM" title="Apply config changes for Nimbus">
        <task id="hdf_2_3_0_0_update_storm_env" xsi:type="configure" />
      </execute-stage>

      <execute-stage component="NIMBUS" service="STORM" title="Apply config changes for Nimbus">
        <task id="hdf_2_3_0_0_nimbus_update_env_vars" xsi:type="configure" />
      </execute-stage>
    </group>

    
    <group name="ZOOKEEPER" title="ZooKeeper" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <parallel-scheduler />
      <service name="ZOOKEEPER">
        <service-check>false</service-check>
        <component>ZOOKEEPER_SERVER</component>
        <component>ZOOKEEPER_CLIENT</component>
      </service>
    </group>

    <group name="HDFS" title="HDFS" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <parallel-scheduler />
      <service name="HDFS">
        <component>JOURNALNODE</component>
        <component>ZKFC</component>
        <component>NAMENODE</component>
        <component>SECONDARY_NAMENODE</component>
        <component>HDFS_CLIENT</component>
      </service>
    </group>

    <group name="HDFS_DATANODES" title="HDFS DataNodes" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <parallel-scheduler />
      <service name="HDFS">
        <component>DATANODE</component>
      </service>
    </group>

    <group name="HDFS_LEAVE_SAFEMODE" title="HDFS - Wait to leave Safemode" xsi:type="cluster">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>

      <execute-stage component="NAMENODE" service="HDFS" title="Wait to leave Safemode">
        <task hosts="all" summary="Wait for NameNode to leave Safemode" xsi:type="execute">
          <script>scripts/namenode.py</script>
          <function>wait_for_safemode_off</function>
        </task>
      </execute-stage>
    </group>

    <group name="YARN_AND_MAPR" title="YARN and MapReduce2" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <parallel-scheduler />

      <service name="MAPREDUCE2">
        <component>HISTORYSERVER</component>
        <component>MAPREDUCE2_CLIENT</component>
      </service>

      <service name="YARN">
        <component>APP_TIMELINE_SERVER</component>
        <component>RESOURCEMANAGER</component>
        <component>YARN_CLIENT</component>
      </service>
    </group>

    <group name="YARN_NODEMANAGERS" title="YARN NodeManagers" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <parallel-scheduler />

      <service name="YARN">
        <component>NODEMANAGER</component>
      </service>
    </group>

    <group name="HBASE" title="HBASE" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <parallel-scheduler />
      <service name="HBASE">
        <component>HBASE_MASTER</component>
        <component>HBASE_REGIONSERVER</component>
        <component>HBASE_CLIENT</component>
      </service>
    </group>

    <group name="CLIENTS" title="Tez, Pig, Sqoop Clients" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <parallel-scheduler />
      <service name="TEZ">
        <component>TEZ_CLIENT</component>
      </service>

      <service name="PIG">
        <component>PIG</component>
      </service>

      <service name="SQOOP">
        <component>SQOOP</component>
      </service>
    </group>

    <group name="SERVICE_CHECK" title="All Service Checks" xsi:type="service-check">
      <skippable>true</skippable>
      <direction>UPGRADE</direction>
      <priority>
        <service>HDFS</service>
        <service>YARN</service>
        <service>MAPREDUCE2</service>
        <service>HBASE</service>
      </priority>
    </group>

    <group name="HIVE_MASTERS" title="Hive Masters" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      
      <parallel-scheduler>
        <max-degree-of-parallelism>1</max-degree-of-parallelism>
      </parallel-scheduler>
      <service name="HIVE">
        <component>HIVE_METASTORE</component>
        <component>HIVE_SERVER</component>
        <component>WEBHCAT_SERVER</component>
      </service>
    </group>

    <group name="HIVE_CLIENTS" title="Hive Clients" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <parallel-scheduler />
      <service name="HIVE">
        <component>HIVE_CLIENT</component>
        <component>HCAT</component>
      </service>
    </group>

    <group name="OOZIE" title="Oozie" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <parallel-scheduler />
      <service name="OOZIE">
        <component>OOZIE_SERVER</component>
      </service>
    </group>

    <group name="OOZIE_CLIENTS" title="Oozie Clients" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <parallel-scheduler />
      <service name="OOZIE">
        <component>OOZIE_CLIENT</component>
      </service>
    </group>

    <group name="FALCON" title="Falcon" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <parallel-scheduler />
      <service name="FALCON">
        <component>FALCON_SERVER</component>
      </service>
    </group>

    <group name="FALCON_CLIENTS" title="Falcon Clients" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <parallel-scheduler />
      <service name="FALCON">
        <component>FALCON_CLIENT</component>
      </service>
    </group>

    <group name="STORM" title="Storm" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <parallel-scheduler />
      <service name="STORM">
        <component>NIMBUS</component>
        <component>STORM_REST_API</component>
        <component>SUPERVISOR</component>
        <component>STORM_UI_SERVER</component>
        <component>DRPC_SERVER</component>
      </service>

      <execute-stage component="DRPC_SERVER" service="STORM" title="Rebuild Storm Topology">
        <task xsi:type="manual">
          <message>Please rebuild your topology using the new Storm version dependencies and resubmit it using the newly created jar.</message>
        </task>
      </execute-stage>
    </group>

    <group name="FLUME" title="Flume" xsi:type="restart">
      <service-check>false</service-check>
      <skippable>true</skippable>
      <parallel-scheduler />
      <service name="FLUME">
        <component>FLUME_HANDLER</component>
      </service>
    </group>

    
    <group name="ALL_HOST_OPS" title="Set Version On All Hosts" xsi:type="cluster">
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>
      <execute-stage title="Update stack to {{version}}">
        <task xsi:type="execute">
          <script>scripts/ru_set_all.py</script>
          <function>actionexecute</function>
        </task>
      </execute-stage>
    </group>

    <group name="FINALIZE_PRE_CHECK" title="Finalize {{direction.text.proper}} Pre-Check" xsi:type="cluster">
      <direction>UPGRADE</direction>
      
      <execute-stage title="Check Component Versions">
        <task class="org.apache.ambari.server.serveraction.upgrades.ComponentVersionCheckAction" xsi:type="server_action" />
      </execute-stage>
    </group>

    <group name="POST_CLUSTER" title="Finalize {{direction.text.proper}}" xsi:type="cluster">
      <skippable>true</skippable>
      <supports-auto-skip-failure>false</supports-auto-skip-failure>

      <execute-stage title="Confirm Finalize">
        <direction>UPGRADE</direction>
        <task xsi:type="manual">
          <message>Please confirm you are ready to finalize.</message>
        </task>
      </execute-stage>

      <execute-stage component="NAMENODE" service="HDFS" title="Execute HDFS Finalize">
        <task hosts="master" xsi:type="execute">
          <script>scripts/namenode.py</script>
          <function>finalize_non_rolling_upgrade</function>
        </task>
      </execute-stage>

      <execute-stage component="" service="" title="Save Cluster State">
        <task class="org.apache.ambari.server.serveraction.upgrades.FinalizeUpgradeAction" xsi:type="server_action">
        </task>
      </execute-stage>
    </group>
  </order>

  <processing>
    <service name="ZOOKEEPER">
      <component name="ZOOKEEPER_SERVER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="ZOOKEEPER_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="HDFS">
      <component name="NAMENODE">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="SECONDARY_NAMENODE">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="DATANODE">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="HDFS_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="JOURNALNODE">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="ZKFC">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="MAPREDUCE2">
      <component name="HISTORYSERVER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="MAPREDUCE2_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="YARN">
      <component name="APP_TIMELINE_SERVER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="RESOURCEMANAGER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="NODEMANAGER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="YARN_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="HBASE">
      <component name="HBASE_MASTER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="HBASE_REGIONSERVER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="HBASE_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="TEZ">
      <component name="TEZ_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="PIG">
      <component name="PIG">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="SQOOP">
      <component name="SQOOP">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="HIVE">
      <component name="HIVE_METASTORE">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="HIVE_SERVER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="WEBHCAT_SERVER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="HIVE_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="HCAT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="OOZIE">
      <component name="OOZIE_SERVER">
        <pre-upgrade>
          
          <task xsi:type="configure_function" />

          <task hosts="first" sequential="true" summary="Upgrading the Oozie database and creating a new sharelib" xsi:type="execute">
            <script>scripts/oozie_server_upgrade.py</script>
            <function>upgrade_oozie_database_and_sharelib</function>
          </task>
        </pre-upgrade>

        <pre-downgrade>
          <task hosts="any" sequential="true" summary="Create a new sharelib" xsi:type="execute">
            <script>scripts/oozie_server_upgrade.py</script>
            <function>create_sharelib</function>
          </task>
        </pre-downgrade>

        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="OOZIE_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="FALCON">
      <component name="FALCON_SERVER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
      <component name="FALCON_CLIENT">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>

    <service name="STORM">
      <component name="NIMBUS">
        <pre-upgrade>
          <task summary="Removing Storm data from ZooKeeper" xsi:type="execute">
            <script>scripts/storm_upgrade.py</script>
            <function>delete_storm_zookeeper_data</function>
          </task>

          <task summary="Removing local Storm data" xsi:type="execute">
            <script>scripts/storm_upgrade.py</script>
            <function>delete_storm_local_data</function>
          </task>
        </pre-upgrade>

        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="SUPERVISOR">
        <pre-upgrade>
          <task summary="Removing local Storm data" xsi:type="execute">
            <script>scripts/storm_upgrade.py</script>
            <function>delete_storm_local_data</function>
          </task>
        </pre-upgrade>

        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="STORM_UI_SERVER">
        <pre-upgrade>
          <task summary="Removing local Storm data" xsi:type="execute">
            <script>scripts/storm_upgrade.py</script>
            <function>delete_storm_local_data</function>
          </task>
        </pre-upgrade>

        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>

      <component name="DRPC_SERVER">
        <pre-upgrade>
          <task summary="Removing local Storm data" xsi:type="execute">
            <script>scripts/storm_upgrade.py</script>
            <function>delete_storm_local_data</function>
          </task>
        </pre-upgrade>

        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>

        <post-upgrade>
          <task xsi:type="manual">
            <message>Please rebuild your topology using the new Storm version dependencies and resubmit it using the newly created jar.</message>
          </task>
        </post-upgrade>
      </component>
    </service>

    <service name="FLUME">
      <component name="FLUME_HANDLER">
        <upgrade>
          <task xsi:type="restart-task" />
        </upgrade>
      </component>
    </service>
  </processing>
</upgrade>